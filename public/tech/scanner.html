<script type="module">
import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";

const video = document.getElementById("preview");
const resultEl = document.getElementById("result");
const applyBtn = document.getElementById("applyBtn");
const reader = new BrowserMultiFormatReader();

async function startScanner() {
  resultEl.textContent = "Warten auf Scan…";
  resultEl.className = "";
  applyBtn.style.display = "none";

  const devices = await BrowserMultiFormatReader.listVideoInputDevices();
  if (!devices.length) {
    resultEl.textContent = "Keine Kamera gefunden";
    resultEl.className = "err";
    return;
  }

  reader.decodeOnceFromVideoDevice(devices[0].deviceId, video)
    .then(res => handleScan(res.getText().trim()))
    .catch(err => {
      console.error(err);
      resultEl.textContent = "Scan-Fehler";
      resultEl.className = "err";
    });
}

async function handleScan(id) {
  resultEl.textContent = `Scanne ${id}…`;
  try {
    // Ask server to toggle this item
    const res = await fetch("/tech/save-scan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, mode: "toggle" })
    });
    const data = await res.json();
    if (data.error) {
      resultEl.textContent = "❌ " + data.error;
      resultEl.className = "err";
    } else {
      const avail = data.item.available;
      resultEl.innerHTML =
        `✅ ${data.item.name}<br>` +
        (avail ? "Jetzt **verfügbar (Check-In)**" : "Jetzt **ausgegeben (Check-Out)**");
      resultEl.className = avail ? "ok" : "err";
    }
  } catch (e) {
    resultEl.textContent = "Fehler beim Verbinden mit Server";
    resultEl.className = "err";
  }
  applyBtn.style.display = "inline-block";
}

applyBtn.addEventListener("click", () => {
  applyBtn.style.display = "none";
  startScanner();
});

startScanner();
</script>
