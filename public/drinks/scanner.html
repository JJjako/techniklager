<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Getränke Scanner</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 12px; }
  video { width: 90%; max-width: 480px; border: 1px solid #ccc; border-radius: 6px; margin-top: 10px; }
  #result { margin-top: 15px; font-size: 1.1rem; }
  .ok { color: #0a0; }
  .err { color: #a00; }
  #applyBtn {
    margin-top: 20px;
    display: none;
    padding: 10px 20px;
    font-size: 1rem;
    background: #0077cc;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #applyBtn:hover { background: #005fa3; }
</style>
</head>
<body>
  <h1>Getränke Scanner</h1>
  <p>Mode: <strong id="modeLabel"></strong></p>
  <p>
    <label>
      Anzahl:
      <input type="number" id="count" value="1" min="1" style="width:60px;text-align:center;">
    </label>
  </p>
  <video id="preview" autoplay playsinline></video>
  <p id="result">Warten auf Scan…</p>
  <button id="applyBtn">Nächster Scan</button>

<script type="module">
import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm';

const video = document.getElementById('preview');
const resultEl = document.getElementById('result');
const applyBtn = document.getElementById('applyBtn');
const modeLabel = document.getElementById('modeLabel');

const params = new URLSearchParams(window.location.search);
const mode = params.get('mode') || 'checkout';
modeLabel.textContent = mode.toUpperCase();

let codeReader = new BrowserMultiFormatReader();
let scanning = false;

// Start scanning
async function startScanner() {
  resultEl.textContent = 'Warten auf Scan…';
  resultEl.className = '';
  applyBtn.style.display = 'none';
  scanning = true;

  const devices = await BrowserMultiFormatReader.listVideoInputDevices();
  if (!devices.length) {
    resultEl.textContent = 'Keine Kamera gefunden';
    resultEl.className = 'err';
    return;
  }
  const deviceId = devices[0].deviceId;

  codeReader.decodeOnceFromVideoDevice(deviceId, video).then(result => {
    if (!result) return;
    scanning = false;
    const id = result.getText().trim();
    const count = parseInt(document.getElementById('count').value) || 1;
    handleScan(id, count);
  }).catch(err => {
    console.error(err);
    resultEl.textContent = 'Fehler beim Scannen';
    resultEl.className = 'err';
    scanning = false;
  });
}

async function handleScan(id, count) {
  resultEl.textContent = `Sende Scan für ${id} (${count}x)…`;
  resultEl.className = '';

  try {
    const res = await fetch('/api/drinks/scan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, mode, count })
    });
    const data = await res.json();
    if (data.error) {
      resultEl.textContent = `❌ Fehler: ${data.error}`;
      resultEl.className = 'err';
    } else {
      resultEl.textContent = `✅ ${data.name} → Menge: ${data.quantity}`;
      resultEl.className = 'ok';
    }
  } catch (e) {
    console.error(e);
    resultEl.textContent = 'Fehler beim Verbinden mit Server';
    resultEl.className = 'err';
  }

  applyBtn.style.display = 'inline-block';
}

// When user presses “Apply”, start the next scan
applyBtn.addEventListener('click', () => {
  applyBtn.style.display = 'none';
  startScanner();
});

// Start first scan automatically
startScanner();
</script>
</body>
</html>
